#!/bin/bash
# APEX Images Verification Script
# Generated by Ansible for APEX {{ apex_version }}

echo "=== APEX {{ apex_version }} Images Verification ==="
echo "Date: $(date)"
echo "Host: {{ inventory_hostname }}"
echo

# Check directories
echo "Checking APEX directories..."
if [ -d "{{ apex_images_dir }}" ]; then
    echo "✓ APEX images directory exists: {{ apex_images_dir }}"
    echo "  Directory size: $(du -sh {{ apex_images_dir }} | cut -f1)"
    echo "  Number of files: $(find {{ apex_images_dir }} -type f | wc -l)"
    echo "  Number of directories: $(find {{ apex_images_dir }} -type d | wc -l)"
else
    echo "✗ APEX images directory missing: {{ apex_images_dir }}"
fi

if [ -d "{{ apex_install_dir }}" ]; then
    echo "✓ APEX installation directory exists: {{ apex_install_dir }}"
else
    echo "✗ APEX installation directory missing: {{ apex_install_dir }}"
fi

echo

# Check key subdirectories
echo "Checking key APEX subdirectories..."
for dir in apex_ui libraries themes; do
    if [ -d "{{ apex_images_dir }}/$dir" ]; then
        echo "✓ $dir directory exists"
    else
        echo "✗ $dir directory missing"
    fi
done

echo

# Check Tomcat context
echo "Checking Tomcat configuration..."
if [ -f "{{ tomcat_home }}/conf/Catalina/localhost/{{ apex_images_context_name }}.xml" ]; then
    echo "✓ APEX context configuration exists"
else
    echo "✗ APEX context configuration missing"
fi

echo

# Check permissions
echo "Checking permissions..."
echo "APEX images directory owner: $(stat -c '%U:%G' {{ apex_images_dir }} 2>/dev/null || echo 'N/A')"
echo "APEX images directory permissions: $(stat -c '%a' {{ apex_images_dir }} 2>/dev/null || echo 'N/A')"

echo

# Test URL accessibility (if running)
echo "Testing URL accessibility..."
if systemctl is-active --quiet tomcat; then
    echo "Tomcat is running, testing APEX images URL..."
    if command -v curl >/dev/null 2>&1; then
        HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:{{ tomcat_port }}/{{ apex_images_context_name }}/ 2>/dev/null || echo "000")
        if [ "$HTTP_CODE" = "200" ] || [ "$HTTP_CODE" = "403" ]; then
            echo "✓ APEX images context is accessible (HTTP $HTTP_CODE)"
        else
            echo "✗ APEX images context not accessible (HTTP $HTTP_CODE)"
        fi
    else
        echo "curl not available for URL testing"
    fi
else
    echo "Tomcat is not running, cannot test URL accessibility"
fi

echo
echo "=== Verification Complete ==="